<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Store Form Submission</title>
</head>
<body>
  <h1>Submit Your Info</h1>
  <form id="myForm">
    <input type="text" name="name" placeholder="Your Name" required />
    <input type="email" name="email" placeholder="Your Email" required />
    <input type="text" name="address" id="address" placeholder="Address" required />
    <input type="text" name="store" id="store" placeholder="Nearest Store ID" readonly required />
    <input type="hidden" name="latitude" id="latitude" />
    <input type="hidden" name="longitude" id="longitude" />
    <button type="submit">Submit</button>
  </form>

  <script type="module">
    import { db } from './firebaseConfig.js';
    import { collection, addDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    import stores from './stores.json' assert { type: 'json' };

    const form = document.getElementById("myForm");

    // Calculate distance in meters
    function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function findStoreByAddress(address) {
      return stores.find(store => address.includes(store.address));
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const userLat = parseFloat(document.getElementById("latitude").value);
      const userLon = parseFloat(document.getElementById("longitude").value);
      const userAddress = document.getElementById("address").value;

      const matchedStore = findStoreByAddress(userAddress);

      if (!matchedStore) {
        alert("No store found for this address!");
        return;
      }

      const distance = getDistanceFromLatLonInMeters(userLat, userLon, matchedStore.latitude, matchedStore.longitude);
      const maxDistance = 20; // meters

      if (distance > maxDistance) {
        alert(`You are too far from the store! Distance: ${Math.round(distance)} meters`);
        return;
      }

      document.getElementById("store").value = matchedStore.id;

      try {
        await addDoc(collection(db, "submissions"), {
          name: form.name.value,
          email: form.email.value,
          address: userAddress,
          store: matchedStore.id,
          latitude: userLat,
          longitude: userLon,
          timestamp: new Date()
        });
        alert("Form submitted successfully!");
        form.reset();
      } catch (error) {
        console.error("Error adding document: ", error);
        alert("Failed to submit form!");
      }
    });

    // Get user location
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(
        (position) => {
          document.getElementById("latitude").value = position.coords.latitude;
          document.getElementById("longitude").value = position.coords.longitude;
        },
        (err) => alert("Unable to get your location: " + err.message)
      );
    } else {
      alert("Geolocation is not supported by your browser.");
    }
  </script>
</body>
</html>
