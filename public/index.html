<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geo Store Form</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    label { display: block; margin: 10px 0 5px; }
    input { padding: 5px; width: 100%; max-width: 400px; }
    button { padding: 10px 20px; margin-top: 10px; }
    .status-success { color: green; margin-top: 10px; }
    .status-error { color: red; margin-top: 10px; }
  </style>
  <!-- Include Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <h1>Find Your Store & Submit Info</h1>
  <form id="geoForm">
    <label for="storeLocation">Nearest Store</label>
    <input type="text" id="storeLocation" value="Searching..." readonly>

    <label for="latitude">Latitude</label>
    <input type="text" id="latitude" readonly>

    <label for="longitude">Longitude</label>
    <input type="text" id="longitude" readonly>

    <label for="readableAddress">Address</label>
    <input type="text" id="readableAddress" readonly>

    <label for="name">Name</label>
    <input type="text" id="name" required>

    <label for="email">Email</label>
    <input type="email" id="email" required>

    <button type="submit" id="submitBtn" disabled>Submit</button>
  </form>

  <div id="locationStatus"></div>

  <script>
    // Your Firebase configuration
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const storeLocationInput = document.getElementById("storeLocation");
    const latInput = document.getElementById("latitude");
    const lonInput = document.getElementById("longitude");
    const addrInput = document.getElementById("readableAddress");
    const statusDiv = document.getElementById("locationStatus");
    const submitBtn = document.getElementById("submitBtn");

    // Example store list
    const stores = [
      { id: "store1", name: "Main Street Store", lat: 40.7128, lon: -74.0060 },
      { id: "store2", name: "Downtown Store", lat: 40.73061, lon: -73.935242 }
    ];

    function haversineDistance(lat1, lon1, lat2, lon2) {
      const toRad = (x) => (x * Math.PI) / 180;
      const R = 6371; // km
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    async function detectStore() {
      if (!navigator.geolocation) {
        statusDiv.className = "status-error";
        statusDiv.textContent = "Geolocation not supported by your browser.";
        storeLocationInput.value = "Store Not Found";
        return;
      }

      navigator.geolocation.getCurrentPosition(async (position) => {
        const userLat = position.coords.latitude;
        const userLon = position.coords.longitude;

        latInput.value = userLat;
        lonInput.value = userLon;

        // Find nearest store
        let nearestStore = null;
        let minDistance = Infinity;

        for (const store of stores) {
          const dist = haversineDistance(userLat, userLon, store.lat, store.lon);
          if (dist < minDistance) {
            minDistance = dist;
            nearestStore = store;
          }
        }

        if (nearestStore && minDistance <= 50) { // 50km radius
          storeLocationInput.value = nearestStore.id;
          submitBtn.disabled = false;
        } else {
          storeLocationInput.value = "Store Not Found";
        }

        // Get readable address using OpenStreetMap Nominatim
        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${userLat}&lon=${userLon}`);
          const data = await res.json();
          addrInput.value = data.display_name || "Address Not Found";
        } catch (err) {
          addrInput.value = "Address Not Found";
        }
      }, (err) => {
        statusDiv.className = "status-error";
        statusDiv.textContent = "Unable to get location: " + err.message;
        storeLocationInput.value = "Store Not Found";
      });
    }

    async function handleFormSubmit(event) {
      event.preventDefault();

      const storeId = storeLocationInput.value;
      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const latitude = latInput.value;
      const longitude = lonInput.value;
      const address = addrInput.value;

      if (!storeId || storeId === "Searching..." || storeId === "Store Not Found") {
        statusDiv.className = "status-error";
        statusDiv.innerHTML = "<span>Please wait until your store is detected.</span>";
        return;
      }

      if (!name || !email) {
        statusDiv.className = "status-error";
        statusDiv.innerHTML = "<span>Please fill in all required fields.</span>";
        return;
      }

      const formData = { storeId, name, email, latitude, longitude, address, timestamp: new Date() };

      try {
        await db.collection("yourCollectionName").add(formData);
        statusDiv.className = "status-success";
        statusDiv.innerHTML = "<span>Form submitted successfully!</span>";
        document.getElementById("geoForm").reset();
        storeLocationInput.value = "Searching...";
        submitBtn.disabled = true;
        detectStore(); // re-detect store for next submission
      } catch (error) {
        console.error("Error submitting form:", error);
        statusDiv.className = "status-error";
        statusDiv.innerHTML = "<span>Failed to submit form. Please try again.</span>";
      }
    }

    document.getElementById("geoForm").addEventListener("submit", handleFormSubmit);

    // Detect store on page load
    detectStore();
  </script>
</body>
</html>
